from fastapi import FastAPI, Query, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import aiohttp
import asyncio
import time

app = FastAPI()

// ðŸ”¥ AstraCloud - API Cuaca Gratis & Tanpa Limit
// ðŸš€ Dibuat oleh AstraCloud â†’ https://astracloud.wordpress.com

# Konfigurasi CORS agar API bisa diakses dari mana saja
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

BASE_URL = "https://api.open-meteo.com/v1/forecast"

// ðŸ“Œ Cache sederhana untuk mengurangi request ke API
cache_data = {}
cache_time = {}

async def fetch_weather(params: dict):
    """ // ðŸ”„ Fungsi untuk mengambil data cuaca dari API eksternal dengan retry """
    url = BASE_URL
    max_retries = 3
    timeout = 5  # Maksimal waktu tunggu

    for attempt in range(max_retries):
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url, params=params, timeout=timeout) as response:
                    if response.status == 200:
                        return await response.json()
        except Exception:
            if attempt < max_retries - 1:
                await asyncio.sleep(2)  # Tunggu sebelum retry
            else:
                raise HTTPException(status_code=500, detail="Gagal mengambil data cuaca.")

@app.get("/cuaca/")
async def get_weather(
    kota: str,
    lat: float,
    lon: float,
    hari: int = Query(1, ge=1, le=7),
    format: str = "json"
):
    """
    // ðŸš€ API Cuaca AstraCloud (Gratis & Tanpa Limit)
    // ðŸ”— Contoh: /cuaca/?kota=Jakarta&lat=-6.2088&lon=106.8456&hari=3&format=json
    // ðŸŽ¯ Format: json / text (untuk bot Telegram)
    """

    cache_key = f"{lat}_{lon}_{hari}"
    now = time.time()

    // âš¡ Cek cache (jika ada dan belum kadaluarsa 10 menit)
    if cache_key in cache_data and (now - cache_time.get(cache_key, 0)) < 600:
        data = cache_data[cache_key]
    else:
        params = {
            "latitude": lat,
            "longitude": lon,
            "current_weather": "true",
            "daily": "temperature_2m_max,temperature_2m_min,precipitation_sum,humidity_2m_max,humidity_2m_min,windspeed_10m_max,windspeed_10m_min",
            "timezone": "Asia/Jakarta",
            "forecast_days": hari
        }
        data = await fetch_weather(params)
        cache_data[cache_key] = data
        cache_time[cache_key] = now

    if "current_weather" not in data or "daily" not in data:
        raise HTTPException(status_code=500, detail="Data cuaca tidak tersedia.")

    cuaca_sekarang = data["current_weather"]
    prediksi = data["daily"]

    hasil = {
        "ðŸ“ Kota": kota,
        "ðŸŒ¡ï¸ Suhu Saat Ini": f"{cuaca_sekarang['temperature']}Â°C",
        "ðŸ’§ Kelembaban": f"{cuaca_sekarang.get('humidity', 'N/A')}%",  // Handle jika `humidity` kosong
        "ðŸ’¨ Kecepatan Angin": f"{cuaca_sekarang['windspeed']} km/h",
        "ðŸ§­ Arah Angin": f"{cuaca_sekarang['winddirection']}Â°",
        "ðŸ•’ Update": cuaca_sekarang["time"],
        "ðŸ“… Prediksi Cuaca": [
            {
                "ðŸ“† Tanggal": prediksi["time"][i],
                "ðŸŒ¡ï¸ Suhu Max": f"{prediksi['temperature_2m_max'][i]}Â°C",
                "ðŸŒ¡ï¸ Suhu Min": f"{prediksi['temperature_2m_min'][i]}Â°C",
                "ðŸ’§ Kelembaban Max": f"{prediksi.get('humidity_2m_max', [None])[i]}%",  // Handle jika `humidity_2m_max` kosong
                "ðŸ’§ Kelembaban Min": f"{prediksi.get('humidity_2m_min', [None])[i]}%",  // Handle jika `humidity_2m_min` kosong
                "ðŸŒ§ï¸ Curah Hujan": f"{prediksi['precipitation_sum'][i]} mm",
                "ðŸ’¨ Angin Max": f"{prediksi['windspeed_10m_max'][i]} km/h",
                "ðŸ’¨ Angin Min": f"{prediksi['windspeed_10m_min'][i]} km/h",
            }
            for i in range(hari)
        ]
    }

    // ðŸ”„ Format teks untuk bot Telegram
    if format == "text":
        teks = f"ðŸŒ **Cuaca di {kota}**:\n"
        teks += f"ðŸŒ¡ï¸ Suhu Saat Ini: {cuaca_sekarang['temperature']}Â°C\n"
        teks += f"ðŸ’§ Kelembaban: {cuaca_sekarang.get('humidity', 'N/A')}%\n"
        teks += f"ðŸ’¨ Kecepatan Angin: {cuaca_sekarang['windspeed']} km/h\n"
        teks += f"ðŸ•’ Update: {cuaca_sekarang['time']}\n\n"
        teks += "ðŸ”® **Prediksi Cuaca:**\n"
        for p in hasil["ðŸ“… Prediksi Cuaca"]:
            teks += f"ðŸ“† {p['ðŸ“† Tanggal']} | ðŸŒ¡ï¸ {p['ðŸŒ¡ï¸ Suhu Max']} - {p['ðŸŒ¡ï¸ Suhu Min']} | ðŸ’§ {p['ðŸ’§ Kelembaban Max']} - {p['ðŸ’§ Kelembaban Min']} | ðŸŒ§ï¸ {p['ðŸŒ§ï¸ Curah Hujan']} mm | ðŸ’¨ {p['ðŸ’¨ Angin Max']} - {p['ðŸ’¨ Angin Min']} km/h\n"
        teks += "\n\n// ðŸš€ API by AstraCloud â†’ https://astracloud.wordpress.com"
        return {"text": teks}

    // ðŸŽ¯ Hasil JSON
    hasil["//"] = "API by AstraCloud â†’ https://astracloud.wordpress.com"
    return hasil
